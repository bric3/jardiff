name: CI

on:
  push:
    branches: [main, workflow]
  pull_request:
    branches: [main]

env:
  RELEASE_BRANCH: workflow

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      checks: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: '25'
          distribution: 'graalvm-community'
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          validate-wrappers: true

      - name: Build with Gradle
        run: ./gradlew build

      - name: Run tests
        run: ./gradlew test

#      - name: Build native image
#        run: ./gradlew nativeCompile

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        if: success()
        with:
          name: jardiff-jar
          path: jardiff/build/libs/*.jar
          retention-days: 7

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v5
        if: always()
        with:
          report_paths: '**/build/test-results/**/TEST-*.xml'
          check_name: Test Results
          detailed_summary: true
          include_passed: true
          fail_on_failure: true

      - name: Upload test reports
        uses: actions/upload-artifact@v6
        if: failure()
        with:
          name: test-reports
          path: |
            jardiff/build/reports/tests/
            jardiff-differ/build/reports/tests/
          retention-days: 7

      - name: Get version and prepare release info
        if: github.event_name == 'push' && github.ref == format('refs/heads/{0}', env.RELEASE_BRANCH)
        id: release_info
        run: |
          VERSION=$(./gradlew properties | grep "^version:" | awk '{print $2}')
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          SHORT_SHA=$(git rev-parse --short HEAD)
          TAG="latest-build"

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Find JAR and native binary
        if: github.event_name == 'push' && github.ref == format('refs/heads/{0}', env.RELEASE_BRANCH)
        id: artifacts
        run: |
          JAR_FILE=$(find jardiff/build/libs -name "*.jar" -type f | head -n 1)
          JAR_NAME=$(basename "$JAR_FILE")
          echo "jar_path=${JAR_FILE}" >> $GITHUB_OUTPUT
          echo "jar_name=${JAR_NAME}" >> $GITHUB_OUTPUT

          NATIVE_FILE=$(find jardiff/build/native -type f -executable 2>/dev/null | head -n 1)
          if [ -n "$NATIVE_FILE" ]; then
            NATIVE_NAME=$(basename "$NATIVE_FILE")
            echo "native_path=${NATIVE_FILE}" >> $GITHUB_OUTPUT
            echo "native_name=${NATIVE_NAME}" >> $GITHUB_OUTPUT
            echo "has_native=true" >> $GITHUB_OUTPUT
          else
            echo "has_native=false" >> $GITHUB_OUTPUT
          fi

      - name: Create or Update Draft Release
        if: github.event_name == 'push' && github.ref == format('refs/heads/{0}', env.RELEASE_BRANCH)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.release_info.outputs.tag }}"

          # Prepare release notes
          cat > release_notes.md << EOF
          Automated build from ${{ github.ref_name }}

          **Version:** ${{ steps.release_info.outputs.version }}
          **Commit:** ${{ github.sha }} (${{ steps.release_info.outputs.short_sha }})
          **Branch:** ${{ github.ref_name }}
          **Built:** \$(date +'%Y-%m-%d %H:%M:%S UTC')

          ## Downloads

          - **JAR**: \`${{ steps.artifacts.outputs.jar_name }}\` - Run with Java 25+
          EOF

          if [ "${{ steps.artifacts.outputs.has_native }}" = "true" ]; then
            cat >> release_notes.md << EOF
          - **Native Binary**: \`${{ steps.artifacts.outputs.native_name }}\` - Standalone executable
          EOF
          fi

          cat >> release_notes.md << EOF

          ### Usage

          **JAR**:
          \`\`\`bash
          java -jar ${{ steps.artifacts.outputs.jar_name }} --help
          \`\`\`
          EOF

          if [ "${{ steps.artifacts.outputs.has_native }}" = "true" ]; then
            cat >> release_notes.md << EOF

          **Native Binary**:
          \`\`\`bash
          ./${{ steps.artifacts.outputs.native_name }} --help
          \`\`\`
          EOF
          fi

          # Check if draft release exists
          if gh release view $TAG --json isDraft --jq '.isDraft' 2>/dev/null | grep -q true; then
            echo "Draft release exists, updating it..."

            # Delete existing assets
            gh release view $TAG --json assets --jq '.assets[].name' | while read -r asset; do
              echo "Deleting asset: $asset"
              gh release delete-asset $TAG "$asset" -y || true
            done

            # Upload new assets
            if [ "${{ steps.artifacts.outputs.has_native }}" = "true" ]; then
              gh release upload $TAG \
                "${{ steps.artifacts.outputs.jar_path }}" \
                "${{ steps.artifacts.outputs.native_path }}" \
                --clobber
            else
              gh release upload $TAG \
                "${{ steps.artifacts.outputs.jar_path }}" \
                --clobber
            fi

            # Update release notes
            gh release edit $TAG \
              --title "Latest Build - ${{ steps.release_info.outputs.timestamp }}" \
              --notes-file release_notes.md

            echo "Draft release updated"
          else
            echo "No draft release found, creating new one..."

            # Delete tag if it exists but isn't a draft release
            git push --delete origin $TAG 2>/dev/null || true

            # Create new draft release
            if [ "${{ steps.artifacts.outputs.has_native }}" = "true" ]; then
              gh release create $TAG \
                "${{ steps.artifacts.outputs.jar_path }}" \
                "${{ steps.artifacts.outputs.native_path }}" \
                --title "Latest Build - ${{ steps.release_info.outputs.timestamp }}" \
                --notes-file release_notes.md \
                --draft
            else
              gh release create $TAG \
                "${{ steps.artifacts.outputs.jar_path }}" \
                --title "Latest Build - ${{ steps.release_info.outputs.timestamp }}" \
                --notes-file release_notes.md \
                --draft
            fi

            echo "Draft release created"
          fi